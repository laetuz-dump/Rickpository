version: 2.1

orbs:
  android: circleci/android@0.2.1

jobs:
  build:
    executor: android/android
    environment:
      JVM: "adopt:17"  # Updated to use Java 17
    steps:
      - checkout
      - restore_cache:
          key: android-orb-v1-
      - run:
          name: Chmod permissions
          command: sudo chmod +x ./gradlew
      - run:
          name: Download Dependencies
          command: ./gradlew androidDependencies
      - save_cache:
          key: 'android-orb-v1-{{ epoch }}'
          paths:
            - ~/.android/build-cache
            - ~/.android/cache
      # Install OpenJDK 17 and set JAVA_HOME
      - run:
          name: Install OpenJDK 17
          command: |
            sudo apt-get update && sudo apt-get install openjdk-17-jdk
            sudo update-alternatives --set java /usr/lib/jvm/java-17-openjdk-amd64/bin/java
            sudo update-alternatives --set javac /usr/lib/jvm/java-17-openjdk-amd64/bin/javac
            echo "export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64" >> $BASH_ENV
            source $BASH_ENV
            java -version
      # Display Gradle Version
      - run:
          name: Display Gradle Version
          command: ./gradlew --version
      # Clear Gradle Cache
      - run:
          name: Clear Gradle Cache
          command: ./gradlew cleanBuildCache
      # Change Gradle version
      - run:
          name: Use Gradle 7.6
          command: echo "distributionUrl=https\://services.gradle.org/distributions/gradle-7.6-all.zip" > gradle/wrapper/gradle-wrapper.properties
      # Run Build with Debugging
      - run:
          name: Run Build with Debugging
          command: ./gradlew build --warning-mode all --stacktrace --debug
      - store_artifacts:
          path: app/build/reports
          destination: reports
      - run:
          name: Run Tests
          command: ./gradlew lint test --scan